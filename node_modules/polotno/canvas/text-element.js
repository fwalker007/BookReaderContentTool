"use strict";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var a in t=arguments[n])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e}).apply(this,arguments)},__awaiter=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{u(r.next(e))}catch(e){o(e)}}function l(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,l)}u((r=r.apply(e,t||[])).next())}))},__generator=this&&this.__generator||function(e,t){var n,r,a,o,i={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return o={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function l(o){return function(l){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(a=2&o[0]?r.return:o[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,o[1])).done)return a;switch(r=0,a&&(o=[2&o[0],a.value]),o[0]){case 0:case 1:a=o;break;case 4:return i.label++,{value:o[1],done:!1};case 5:i.label++,r=o[1],o=[0];continue;case 7:o=i.ops.pop(),i.trys.pop();continue;default:if(!(a=i.trys,(a=a.length>0&&a[a.length-1])||6!==o[0]&&2!==o[0])){i=0;continue}if(3===o[0]&&(!a||o[1]>a[0]&&o[1]<a[3])){i.label=o[1];break}if(6===o[0]&&i.label<a[1]){i.label=a[1],a=o;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(o);break}a[2]&&i.ops.pop(),i.trys.pop();continue}o=t.call(e,i)}catch(e){o=[6,e],r=0}finally{n=a=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,l])}}},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.TextElement=void 0;var react_1=__importDefault(require("react")),mobx_react_lite_1=require("mobx-react-lite"),react_konva_1=require("react-konva"),react_konva_utils_1=require("react-konva-utils"),mobx_1=require("mobx"),konva_1=__importDefault(require("konva")),loader_1=require("../utils/loader"),apply_filters_1=require("./apply-filters"),use_fadein_1=require("./use-fadein"),highlighter_1=require("./highlighter"),styleNode=document.createElement("style");styleNode.type="text/css",document.head.appendChild(styleNode);var initialStyles={border:"none",padding:"0px",overflow:"hidden",background:"none",outline:"none",resize:"none",overflowWrap:"break-word",whiteSpace:"normal",userSelect:"text",wordBreak:"normal"},TextInput=mobx_react_lite_1.observer((function(e){var t=e.textNodeRef,n=e.element,r=e.onBlur,a=e.selectAll,o=e.cursorPosition,i=react_1.default.useState(initialStyles),l=i[0],u=i[1],c=t.current;react_1.default.useLayoutEffect((function(){var e={};e.width=c.width()-2*c.padding()+"px",e.height=c.height()-2*c.padding()+10+"px",e.fontSize=c.fontSize()+"px",e.lineHeight=c.lineHeight()+.01,e.fontFamily='"'+c.fontFamily()+'"',e.textAlign=c.align(),e.color=c.fill();var t="\n        .polotno-input::placeholder {\n          color: "+l.color+";\n          opacity: 0.6;\n        }\n      ";styleNode.innerHTML="",styleNode.appendChild(document.createTextNode(t)),JSON.stringify(e)!==JSON.stringify(l)&&u(e)}));var s=react_1.default.useRef(null);return react_1.default.useEffect((function(){var e,t=s.current;if(t){null===(e=s.current)||void 0===e||e.focus();var n=o||t.value.length;t.selectionStart=t.selectionEnd=n,a&&(null==t||t.select(),document.execCommand("selectAll",!1,null))}}),[]),react_1.default.createElement(react_konva_utils_1.Html,null,react_1.default.createElement("textarea",{className:"polotno-input",ref:s,style:__assign(__assign({},initialStyles),l),value:n.text,onChange:function(e){n.set({text:e.target.value})},placeholder:n.placeholder,onBlur:r}))})),useEditor=function(e){var t=react_1.default.useState(!1),n=t[0],r=t[1],a=react_1.default.useRef(!1);return react_1.default.useEffect((function(){var t=!0;return setTimeout((function(){t&&(e._editModeEnabled&&(a.current=!0),r(!0),setTimeout((function(){a.current=!1}),50))}),50),function(){t=!1}}),[]),{editorEnabled:n&&e._editModeEnabled,selectAll:a.current}},useFontLoader=function(e,t){var n=react_1.default.useState(!1),r=n[0],a=n[1];return react_1.default.useLayoutEffect((function(){var n=!0;return __awaiter(void 0,void 0,void 0,(function(){return __generator(this,(function(o){switch(o.label){case 0:return r&&a(!1),loader_1.incrementLoader(),[4,e.loadFont(t)];case 1:return o.sent(),konva_1.default.Util.requestAnimFrame(loader_1.decrementLoader),n?(a(!0),[2]):[2]}}))})),function(){n=!1}}),[t]),[r]},getLineHeight=function(e){var t=e.fontLoaded,n=e.fontFamily,r=e.fontSize,a=e.lineHeight;return react_1.default.useMemo((function(){if("number"==typeof a)return a;var e=document.createElement("div");e.style.fontFamily=n,e.style.fontSize=r+"px",e.style.lineHeight=a,e.innerText="Test text",document.body.appendChild(e);var t=e.offsetHeight;return document.body.removeChild(e),t/r}),[t,n,r,a])};function getRelativePointerPosition(e){var t=e.getAbsoluteTransform().copy();t.invert();var n=e.getStage().getPointerPosition();return t.point(n)}function getCursorPosition(e){var t,n=e.target,r=getRelativePointerPosition(n),a=n.textArr,o=Math.floor(r.y/(n.fontSize()*n.lineHeight())),i=a.slice(0,o).reduce((function(e,t){return e+t.text.length}),o),l=null!==(t=a[o])&&void 0!==t?t:a[0],u=0;return"right"===n.align()?u=n.width()-l.width:"center"===n.align()&&(u=n.width()/2-l.width/2),i+Math.round((r.x-u)/l.width*l.text.length)}exports.TextElement=mobx_react_lite_1.observer((function(e){var t=e.element,n=e.store,r=react_1.default.useRef(null),a=useEditor(t),o=a.editorEnabled,i=a.selectAll,l=react_1.default.useState(!1),u=l[0],c=l[1],s=n.selectedElements.indexOf(t)>=0;react_1.default.useEffect((function(){if(!t.width){var e=r.current;e.width(600),t.set({width:1.4*e.getTextWidth()})}}),[]),react_1.default.useEffect((function(){var e=r.current;t.height!==e.height()&&t.set({height:e.height()})})),react_1.default.useLayoutEffect((function(){return mobx_1.autorun((function(){var e=r.current;apply_filters_1.applyFilter(e,t)}))}));var f=useFontLoader(n,t.fontFamily)[0];react_1.default.useLayoutEffect((function(){var e=r.current;e&&(e.width(e.width()+1e-8),e._setTextData(),apply_filters_1.applyFilter(e,t))}),[f]);var d=react_1.default.useRef(null),h=react_1.default.useRef(0),_=function(e){n.selectedElements.find((function(e){return e===t}))&&!t.locked&&(h.current=getCursorPosition(e),t.toggleEditMode())},g=!t.text&&t.placeholder,p=t._editModeEnabled?0:g?.6:t.opacity;use_fadein_1.useFadeIn(r,p);var y=getLineHeight({fontLoaded:f,fontFamily:t.fontFamily,fontSize:t.fontSize,lineHeight:t.lineHeight});return react_1.default.createElement(react_1.default.Fragment,null,react_1.default.createElement(react_konva_1.Text,{ref:r,id:t.id,name:"element",x:t.x,y:t.y,rotation:t.rotation,width:t.width,text:t.text||t.placeholder,fill:t.fill,stroke:t.stroke,strokeWidth:t.strokeWidth,fillAfterStrokeEnabled:!0,fontSize:t.fontSize,fontFamily:t.fontFamily,fontStyle:t.fontStyle+" "+t.fontWeight,textDecoration:t.textDecoration,align:t.align,draggable:!t.locked,opacity:p,shadowEnabled:t.shadowEnabled,shadowBlur:t.shadowBlur,lineHeight:y,letterSpacing:t.letterSpacing*t.fontSize,onDragStart:function(){n.history.startTransaction()},onDragEnd:function(e){t.set({x:e.target.x(),y:e.target.y()}),n.history.endTransaction()},onMouseEnter:function(){c(!0)},onMouseLeave:function(){c(!1)},onClick:_,onTap:_,onTransformStart:function(){n.history.startTransaction()},onTransform:function(e){var n,r=(null===(n=e.target.getStage())||void 0===n?void 0:n.findOne("Transformer")).getActiveAnchor();if("middle-left"===r||"middle-right"===r){var a=e.target.scaleX(),o=e.target.width()*a,i=t.fontSize,l=o;o<i&&(l=i,d.current&&e.target.position(d.current)),e.target.width(l),e.target.scaleX(1),apply_filters_1.applyFilter(e.target,t)}e.target.strokeWidth(t.strokeWidth/e.target.scaleX()),d.current=e.target.position()},onTransformEnd:function(e){var r=e.target.scaleX();e.target.scaleX(1),e.target.scaleY(1),e.target.strokeWidth(t.strokeWidth),t.set({fontSize:t.fontSize*r,width:e.target.width()*r,x:e.target.x(),y:e.target.y(),rotation:e.target.rotation()}),n.history.endTransaction()}}),o&&react_1.default.createElement(react_konva_1.Group,{x:t.x,y:t.y,rotation:t.rotation},react_1.default.createElement(TextInput,{textNodeRef:r,element:t,selectAll:i,cursorPosition:h.current,onBlur:function(){t.toggleEditMode(!1)}})),!s&&u&&react_1.default.createElement(highlighter_1.Highlighter,{element:t}))}));