"use strict";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},__rest=this&&this.__rest||function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(e);o<n.length;o++)t.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(r[n[o]]=e[n[o]])}return r},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.registerTransformerAttrs=void 0;var react_1=__importDefault(require("react")),mobx_react_lite_1=require("mobx-react-lite"),mobx_1=require("mobx"),react_konva_1=require("react-konva"),use_image_1=__importDefault(require("use-image")),konva_1=__importDefault(require("konva")),element_1=__importDefault(require("./element")),use_transformer_snap_1=require("./use-transformer-snap"),crop_1=require("../utils/crop"),DEFAULT_TRANSFORMER_ATTRIBUTES={enabledAnchors:["top-left","top-center","top-right","middle-left","bottom-left","bottom-right","bottom-center","middle-right"],rotateEnabled:!0,rotationSnaps:[0,45,90,135,180,225,270,315],ignoreStroke:!0,anchorStrokeWidth:2,borderStrokeWidth:2},transformerAttributes={text:{enabledAnchors:["top-left","top-right","middle-left","bottom-left","bottom-right","middle-right"]},svg:{enabledAnchors:["top-left","top-right","bottom-left","bottom-right"]},many:{enabledAnchors:["top-left","top-right","bottom-left","bottom-right"]}};function registerTransformerAttrs(e,t){transformerAttributes[e]=transformerAttributes[e]||t,Object.assign(transformerAttributes[e],t)}exports.registerTransformerAttrs=registerTransformerAttrs;var Background=function(e){return react_1.default.createElement(react_konva_1.Rect,__assign({},e,{fill:"#e8e8e8"}))},PageBackground=function(e){var t=e.background,r=__rest(e,["background"]),n=t.indexOf("http")>=0||t.indexOf(".png")>=0||t.indexOf(".jpg")>=0,o=use_image_1.default(n?t:"","Anonymous")[0],a=n?react_konva_1.Image:react_konva_1.Rect,i=n&&o?crop_1.getCrop(o,{width:e.width,height:e.height},"center-middle"):{};return react_1.default.createElement(react_1.default.Fragment,null,react_1.default.createElement(react_konva_1.Rect,{x:-1,y:-1,width:e.width+2,height:e.height+2,stroke:"lightgrey",strokeWidth:2,listening:!1}),react_1.default.createElement(a,__assign({image:o},r,{fill:n?"white":t},i)))},Selection=mobx_react_lite_1.observer((function(e){var t=e.selection;return t.visible?react_1.default.createElement(react_konva_1.Rect,{name:"selection",x:Math.min(t.x1,t.x2),y:Math.min(t.y1,t.y2),width:Math.abs(t.x1-t.x2),height:Math.abs(t.y1-t.y2),fill:"rgba(0, 161, 255, 0.3)"}):null})),Elements=mobx_react_lite_1.observer((function(e){var t=e.elements,r=e.store;return react_1.default.createElement(react_1.default.Fragment,null,t.map((function(e){return react_1.default.createElement(element_1.default,{key:e.id,store:r,element:e,onClick:function(){console.warn("Polotno warning: onClick callback is deprecated. Just stop using it. Polotno will do selection automatically.")}})})))}));exports.default=mobx_react_lite_1.observer((function(e){var t=e.store,r=e.page,n=e.xPadding,o=e.yPadding,a=e.width,i=e.height,l=react_1.default.useRef(null),c=react_1.default.useRef(null),s=react_1.default.useRef(null),u=t.selectedElements.find((function(e){return e._cropModeEnabled})),d=t.selectedElements.filter((function(e){return e.locked})).length>0;react_1.default.useEffect((function(){var e,r;if(l.current){var n=l.current.getStage(),o=t.selectedElements.map((function(e){return e._cropModeEnabled?null:n.findOne("#"+e.id)})).filter((function(e){return e})),a=1===t.selectedElements.length&&(null===(e=t.selectedElements[0])||void 0===e?void 0:e.type)||"many";d?(l.current.enabledAnchors([]),l.current.rotateEnabled(!1)):transformerAttributes[a]?(l.current.setAttrs(__assign(__assign({},DEFAULT_TRANSFORMER_ATTRIBUTES),transformerAttributes[a])),"svg"!==a||t.selectedElements[0].keepRatio||l.current.setAttrs({enabledAnchors:DEFAULT_TRANSFORMER_ATTRIBUTES.enabledAnchors})):l.current.setAttrs(DEFAULT_TRANSFORMER_ATTRIBUTES),l.current.nodes(o),null===(r=l.current.getLayer())||void 0===r||r.batchDraw()}}),[t.selectedElements,u,d]);var f=mobx_react_lite_1.useLocalObservable((function(){return{visible:!1,x1:0,y1:0,x2:0,y2:0}})),_=react_1.default.useRef(!1),m=mobx_1.action((function(e){var n;_.current=!1,t.activePage!==r&&r.select();var o=e.target.findAncestor(".elements-container"),a=e.target.findAncestor("Transformer"),i=e.target.findAncestor(".page-abs-container");if(!(o||a||i)){var l=null===(n=e.target.getStage())||void 0===n?void 0:n.getPointerPosition();l&&(f.visible=!0,f.x1=l.x,f.y1=l.y,f.x2=l.x,f.y2=l.y)}}));react_1.default.useEffect((function(){var e=mobx_1.action((function(e){var t,r;if(f.visible){null===(t=c.current)||void 0===t||t.setPointersPositions(e);var n=(null===(r=c.current)||void 0===r?void 0:r.getPointerPosition())||{x:f.x2,y:f.y2};f.x2=n.x,f.y2=n.y}})),r=mobx_1.action((function(){if(f.visible&&c.current){var e=c.current.findOne(".selection"),r=e?e.getClientRect():{width:0,height:0,x:0,y:0};if(r.width&&r.height){var n=[];c.current.find(".element").forEach((function(e){var o=e.getClientRect(),a=t.getElementById(e.id()),i=null==a?void 0:a.locked;konva_1.default.Util.haveIntersection(r,o)&&!i&&n.push(e.id())})),t.selectElements(n)}f.visible=!1,_.current=!0}}));return window.addEventListener("mousemove",e),window.addEventListener("touchmove",e),window.addEventListener("mouseup",r),window.addEventListener("touchend",r),function(){window.removeEventListener("mousemove",e),window.removeEventListener("touchmove",e),window.removeEventListener("mouseup",r),window.removeEventListener("touchend",r)}}),[]);var g=function(e){if(!_.current){var r=e.evt.ctrlKey||e.evt.metaKey||e.evt.shiftKey,n=e.target.findAncestor(".elements-container"),o=e.target.findAncestor(".page-abs-container"),a=e.target.findAncestor("Transformer");if(!(r||n||a||o))t.selectElements([]);else{var i=e.target.findAncestor(".element",!0),l=t.selectedElementsIds.indexOf(null==i?void 0:i.id())>=0;i&&r&&!l&&t.selectElements(t.selectedElementsIds.concat([i.id()])),i&&r&&l&&t.selectElements(t.selectedElementsIds.filter((function(e){return e!==i.id()}))),i&&!r&&t.selectElements([i.id()])}}};return use_transformer_snap_1.useSnap(l),react_1.default.createElement("div",{ref:s,onDragOver:function(e){return e.preventDefault()},onDrop:function(e){var t;e.preventDefault(),c.current.setPointersPositions(e);var r=null===(t=c.current)||void 0===t?void 0:t.findOne(".elements-container"),n=r.getAbsoluteTransform().copy();n.invert();var o=r.getStage().getPointerPosition(),a=n.point(o);window.__polotnoDrop&&window.__polotnoDrop(a)}},react_1.default.createElement(react_konva_1.Stage,{ref:c,width:a,height:i,onClick:g,onTap:g,onMouseDown:m,onTouchStart:m,onDragStart:function(e){if(e.target.hasName("element")){var r=e.target.id();!(t.selectedElementsIds.indexOf(r)>=0)&&r&&t.selectElements([r])}},pageId:r.id,style:{position:"relative"}},react_1.default.createElement(react_konva_1.Layer,null,react_1.default.createElement(Background,{width:a,height:i}),react_1.default.createElement(react_konva_1.Group,{x:n,y:o,scaleX:t.scale,scaleY:t.scale,name:"page-container"},react_1.default.createElement(PageBackground,{width:t.width,height:t.height,background:r.background,shadowBlur:10,shadowColor:"lightgrey",name:"page-background"}),react_1.default.createElement(react_konva_1.Group,{clipX:0,clipY:0,clipWidth:t.width,clipHeight:t.height,name:"elements-container"},react_1.default.createElement(Elements,{elements:r.children,store:t}))),react_1.default.createElement(react_konva_1.Group,{x:n,y:o,scaleX:t.scale,scaleY:t.scale,name:"page-abs-container"},react_1.default.createElement(react_konva_1.Transformer,{ref:l,boundBoxFunc:function(e,t){var r=t.width<1||t.height<1,n=e.width<1||e.height<1;return r&&!n?e:t}})),react_1.default.createElement(Selection,{selection:f}),t._showCredit&&react_1.default.createElement(react_konva_1.Text,{text:"Powered by polotno.dev",fontSize:14,fill:"rgba(0,0,0,0.6)",x:a-156,y:i-18,onMouseEnter:function(e){e.target.getStage().container().style.cursor="pointer"},onMouseLeave:function(e){e.target.getStage().container().style.cursor=""},onTouchStart:function(e){e.cancelBubble=!0},onMouseDown:function(e){e.cancelBubble=!0},onClick:function(){window.open("https://polotno.dev")},onTap:function(){window.open("https://polotno.dev")}}))))}));