"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ImageElement=exports.setImageLoaderHook=void 0;var react_1=__importDefault(require("react")),mobx_react_lite_1=require("mobx-react-lite"),mobx_1=require("mobx"),react_konva_1=require("react-konva"),use_image_1=__importDefault(require("use-image")),konva_1=__importDefault(require("konva")),react_konva_utils_1=require("react-konva-utils"),highlighter_1=require("./highlighter"),loader_1=require("../utils/loader"),apply_filters_1=require("./apply-filters"),use_fadein_1=require("./use-fadein"),useFlip=function(e,t){return react_1.default.useMemo((function(){var r,a,o=e.flipX,i=e.flipY,n="svg"===e.type||e.src.indexOf("data:image/svg+xml")>=0||e.src.indexOf(".svg")>=0;if(!o&&!i&&!n)return t;if(!t)return null;var c=document.createElement("canvas"),l=1;"svg"===e.type&&(l=Math.max(e.width/t.width,e.height/t.height)),c.width=t.width*l||1,c.height=t.height*l||1;var d=o?-c.width:0,h=i?-c.height:0;return null===(r=c.getContext("2d"))||void 0===r||r.scale(o?-1:1,i?-1:1),null===(a=c.getContext("2d"))||void 0===a||a.drawImage(t,d,h,c.width,c.height),c}),[e.flipX,e.flipY,t,e.width,e.height])},usePlaceholder=function(e){var t=e.width,r=e.height,a=e.image,o=e.status,i=react_1.default.useMemo((function(){return a?null:document.createElement("canvas")}),[a]);return react_1.default.useMemo((function(){if(!i)return a;i.width=t,i.height=r;var e=i.getContext("2d");if(!e)return a;var n="failed"===o?"rgba(223, 102, 102, 0.8)":"rgba(124, 173, 212, 0.8)",c="failed"===o?"Can not load the image...":"Loading....";e.fillStyle=n,e.fillRect(0,0,t,r),e.textAlign="center",e.textBaseline="middle";var l=Math.min(30,t/c.length);return e.font=l+"px Arial",e.fillStyle="white",e.fillText(c,t/2,r/2),i}),[t,r,a,o,i])},LoadingPlaceholder=mobx_react_lite_1.observer((function(e){var t=e.element,r=Math.min(30,t.width/4,t.height/4),a=react_1.default.useRef(null);return react_1.default.useEffect((function(){var e=a.current;if(e){var t=new konva_1.default.Animation((function(t){e.rotate(((null==t?void 0:t.timeDiff)||0)/2)}),e.getLayer());return t.start(),function(){t.stop()}}})),react_1.default.createElement(react_konva_1.Group,{x:t.x,y:t.y,rotation:t.rotation,listening:!1,opacity:t.opacity},react_1.default.createElement(react_konva_1.Rect,{width:t.width,height:t.height,fill:"rgba(124, 173, 212, 0.8)"}),react_1.default.createElement(react_konva_1.Arc,{ref:a,x:t.width/2,y:t.height/2,fill:"white",outerRadius:r,innerRadius:Math.max(1,r-5),angle:270}))})),useImageHook=use_image_1.default,setImageLoaderHook=function(e){useImageHook=e};exports.setImageLoaderHook=setImageLoaderHook,exports.ImageElement=mobx_react_lite_1.observer((function(e){var t=e.element,r=e.store,a=react_1.default.useState(!1),o=a[0],i=a[1],n=react_1.default.useRef(null),c=react_1.default.useRef(null),l=react_1.default.useState(!1),d=l[0],h=l[1],u=r.selectedElements.indexOf(t)>=0,g=useImageHook(t.__finalSrc||t.src,"Anonymous"),f=g[0],s=g[1];react_1.default.useEffect((function(){"loading"===s?loader_1.incrementLoader():loader_1.decrementLoader()}),[s]);var _=react_1.default.useState("loading"),p=_[0],m=_[1];react_1.default.useEffect((function(){m(t.__isLoaded?s:"loading")}),[t.__isLoaded,s]),react_1.default.useEffect((function(){"svg"===t.type&&("loading"===p?loader_1.incrementLoader():loader_1.decrementLoader())}),[p]);var v=react_1.default.useRef();react_1.default.useEffect((function(){v.current=f||v.current}),[f]);var y=usePlaceholder({width:t.width||1,height:t.height||1,image:f,status:s}),x="failed"!==s||"failed"!==s&&"svg"===t.type,b=useFlip(t,f||x&&v.current)||y;react_1.default.useEffect((function(){var e;o?null===(e=n.current)||void 0===e||e.clearCache():apply_filters_1.applyFilter(n.current,t)}),[o]),react_1.default.useEffect((function(){apply_filters_1.applyFilter(n.current,t)}),[t.shadowEnabled,t.shadowBlur]);var w=t.cropX,E=t.cropY,M=t.cropWidth,k=t.cropHeight;"loaded"!==s&&(w=E=0,M=k=1);var X,Y,H=b.width*M,S=b.height*k,L=t.width/t.height,W=H/S,R="svg"===t.type;R?(X=H,Y=S):L>=W?(X=H,Y=H/L):(X=S*L,Y=S),react_1.default.useLayoutEffect((function(){if(!o)return apply_filters_1.applyFilter(n.current,t),mobx_1.autorun((function(){apply_filters_1.applyFilter(n.current,t)}),{delay:100})}),[b,o,M,k]),use_fadein_1.useFadeIn(n);var T=Math.max(t.width/X,t.height/Y);react_1.default.useEffect((function(){var e;if(t._cropModeEnabled){var r=null===(e=n.current)||void 0===e?void 0:e.getStage();return document.body.addEventListener("click",o),document.body.addEventListener("touchstart",o),null==r||r.on("click",a),null==r||r.on("touchstart",a),function(){document.body.removeEventListener("click",o),document.body.removeEventListener("touchstart",o),null==r||r.off("click",a),null==r||r.off("click",a)}}function a(e){t._cropModeEnabled&&e.target!==c.current&&t.toggleCropMode(!1)}function o(e){t._cropModeEnabled&&"CANVAS"!==e.target.nodeName&&t.toggleCropMode(!1)}}),[t._cropModeEnabled]);var I=react_1.default.useRef(null),A=react_1.default.useRef(null),C=react_1.default.useRef(null);react_1.default.useLayoutEffect((function(){t._cropModeEnabled&&(A.current.nodes([I.current]),C.current.nodes([c.current]))}),[t._cropModeEnabled]);var D=function(e){Math.round(e.target.x())>0&&(e.target.x(0),e.target.scaleX(1)),Math.round(e.target.y())>0&&(e.target.y(0),e.target.scaleY(1));var r=e.target.width()*e.target.scaleX(),a=e.target.height()*e.target.scaleY(),o=Math.min(1,X/r),i=Math.min(1,Y/a),n=1-o,c=Math.min(n,Math.max(0,Math.round(-e.target.x())/r)),l=1-i,d=Math.min(l,Math.max(0,Math.round(-e.target.y())/a));e.target.setAttrs({x:-c*b.width,y:-d*b.height,scaleX:1,scaleY:1}),t.set({cropX:c,cropY:d,cropWidth:o,cropHeight:i})},q=function(){"svg"!==t.type&&(t.locked||setTimeout((function(){t.toggleCropMode(!0)})))},F="svg"===t.type&&v.current,P="loading"===s&&!F,B=react_1.default.useRef({cropX:0,cropY:0,cropWidth:0,cropHeight:0});return react_1.default.createElement(react_1.default.Fragment,null,P&&react_1.default.createElement(LoadingPlaceholder,{element:t}),react_1.default.createElement(react_konva_1.Image,{ref:n,name:"element",image:b,x:t.x,y:t.y,width:t.width||1,height:t.height||1,rotation:t.rotation,opacity:P?0:t.opacity,shadowEnabled:t.shadowEnabled,shadowBlur:t.shadowBlur,cropX:b.width*w,cropY:b.height*E,cropWidth:X,cropHeight:Y,draggable:!t.locked,onMouseEnter:function(){h(!0)},onMouseLeave:function(){h(!1)},onDragStart:function(){r.history.startTransaction()},onDragMove:function(e){t.set({x:e.target.x(),y:e.target.y()})},onDragEnd:function(e){t.set({x:e.target.x(),y:e.target.y()}),r.history.endTransaction()},id:t.id,onDblClick:q,onDblTap:q,onTransformStart:function(){i(!0),r.history.startTransaction(),B.current={cropX:t.cropX,cropY:t.cropY,cropWidth:t.cropWidth,cropHeight:t.cropHeight}},onTransform:function(e){var r,a=e.currentTarget,o=Math.abs(a.scaleX()-1)<1e-7?1:a.scaleX(),i=Math.abs(a.scaleY()-1)<1e-7?1:a.scaleY();a.scaleX(1),a.scaleY(1);var n=null===(r=e.target.getStage())||void 0===r?void 0:r.findOne("Transformer"),c=1-X/b.width,l=Math.min(c,Math.max(0,t.cropX)),d=1-Y/b.height,h=Math.min(d,Math.max(0,t.cropY)),u=n.getActiveAnchor(),g=!(u.indexOf("middle")>=0||u.indexOf("center")>=0),f=!g&&o<1&&B.current.cropHeight>Y/b.height,s=g?t.cropWidth:t.cropWidth*o;f&&(s=t.cropWidth);var _=!g&&i<1&&B.current.cropWidth>X/b.width,p=g?t.cropHeight:t.cropHeight*i;_&&(p=t.cropHeight),R&&(s=t.cropWidth,p=t.cropHeight),t.set({cropX:l,cropY:h,x:a.x(),y:a.y(),width:a.width()*o,height:a.height()*i,rotation:e.target.rotation(),cropWidth:Math.min(s,1-l),cropHeight:Math.min(p,1-h)})},onTransformEnd:function(e){var a=e.currentTarget;t.set({width:a.width(),height:a.height(),x:a.x(),y:a.y(),rotation:e.target.rotation(),cropWidth:X/b.width,cropHeight:Y/b.height}),i(!1),r.history.endTransaction()}}),react_1.default.createElement(react_konva_1.Rect,{x:t.x,y:t.y,width:t.width-t.borderSize,height:t.height-t.borderSize,offsetX:-t.borderSize/2,offsetY:-t.borderSize/2,stroke:t.borderColor,strokeWidth:t.borderSize,listening:!1,visible:!!t.borderSize,rotation:t.rotation}),t._cropModeEnabled&&react_1.default.createElement(react_konva_utils_1.Portal,{selector:".page-abs-container",enabled:!0},react_1.default.createElement(react_konva_1.Rect,{x:-1500,y:-1500,width:4500,height:4500,fill:"rgba(0,0,0,0.3)"}),react_1.default.createElement(react_konva_1.Image,{listening:!1,image:b,x:t.x,y:t.y,width:t.width,height:t.height,rotation:t.rotation,shadowEnabled:t.shadowEnabled,shadowBlur:t.shadowBlur,cropX:b.width*w,cropY:b.height*E,cropWidth:X,cropHeight:Y}),react_1.default.createElement(react_konva_1.Group,{x:t.x,y:t.y,rotation:t.rotation,scaleX:T,scaleY:T},react_1.default.createElement(react_konva_1.Image,{image:b,ref:c,opacity:.4,draggable:!0,x:-t.cropX*b.width,y:-t.cropY*b.height,onDragMove:D,onTransform:D}),react_1.default.createElement(react_konva_1.Transformer,{ref:C,anchorSize:20,enabledAnchors:["top-left","top-right","bottom-left","bottom-right"],boundBoxFunc:function(e,t){return t.width<5||t.height<5?e:t},rotateEnabled:!1,borderEnabled:!1,anchorCornerRadius:10,anchorStrokeWidth:2,borderStrokeWidth:2}),react_1.default.createElement(react_konva_1.Rect,{width:X,height:Y,ref:I,listening:!1,onTransform:function(e){e.target.x()<-t.cropX*b.width-1e-9&&(e.target.x(-t.cropX*b.width),e.target.scaleX(1)),e.target.y()<-t.cropY*b.height-1e-9&&(e.target.y(-t.cropY*b.height),e.target.scaleY(1));var r=Math.min(1,Math.max(0,t.cropX+e.target.x()/b.width)),a=Math.min(1,Math.max(0,e.target.y()/b.height+t.cropY)),o=e.target.width()*e.target.scaleX(),i=e.target.height()*e.target.scaleY(),n=Math.min(1-r,o/b.width),c=Math.min(1-a,i/b.height),l=e.target.getAbsolutePosition(e.target.getParent().getParent());e.target.scale({x:1,y:1}),e.target.position({x:0,y:0}),t.set({x:l.x,y:l.y,cropX:r,cropY:a,cropWidth:n,cropHeight:c,width:Math.min(o*T,b.width*(1-r)*T),height:Math.min(i*T,b.height*(1-a)*T)})}}),react_1.default.createElement(react_konva_1.Transformer,{ref:A,enabledAnchors:["top-left","top-right","bottom-left","bottom-right"],boundBoxFunc:function(e,t){return t.width<5||t.height<5?e:t},keepRatio:!1,rotateEnabled:!1,anchorFill:"rgb(240, 240, 240)",anchorStrokeWidth:2,borderStrokeWidth:2}))),!u&&d&&react_1.default.createElement(highlighter_1.Highlighter,{element:t}))}));