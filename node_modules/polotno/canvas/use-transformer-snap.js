"use strict";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++)for(var a in t=arguments[n])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e}).apply(this,arguments)},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.useSnap=void 0;var react_1=__importDefault(require("react")),konva_1=__importDefault(require("konva")),math_1=require("../utils/math"),GUIDELINE_OFFSET=5;function getObjectSnappingEdges(e){var t=e.__getNodeRect(),n=math_1.getClientRect(__assign(__assign({},t),{rotation:konva_1.default.Util.radToDeg(t.rotation)})),i=e.getAbsolutePosition();return{vertical:[{guide:n.x,offset:i.x-n.x,snap:"start"},{guide:n.x+n.width/2,offset:i.x-n.x-n.width/2,snap:"center"},{guide:n.x+n.width,offset:i.x-n.x-n.width,snap:"end"}],horizontal:[{guide:n.y,offset:i.y-n.y,snap:"start"},{guide:n.y+n.height/2,offset:i.y-n.y-n.height/2,snap:"center"},{guide:n.y+n.height,offset:i.y-n.y-n.height,snap:"end"}]}}function getGuides(e,t){var n=[],i=[];e.vertical.forEach((function(e){t.vertical.forEach((function(t){var i=Math.abs(e-t.guide);i<GUIDELINE_OFFSET&&n.push({lineGuide:e,diff:i,snap:t.snap,offset:t.offset})}))})),e.horizontal.forEach((function(e){t.horizontal.forEach((function(t){var n=Math.abs(e-t.guide);n<GUIDELINE_OFFSET&&i.push({lineGuide:e,diff:n,snap:t.snap,offset:t.offset})}))}));var a=[],r=n.sort((function(e,t){return e.diff-t.diff}))[0],o=i.sort((function(e,t){return e.diff-t.diff}))[0];return r&&a.push(__assign({orientation:"V"},r)),o&&a.push(__assign(__assign({},o),{orientation:"H"})),a}function useSnap(e){var t=function(e){return e.hasName("element")||e.hasName("page-background")};var n=function(n){n.target.getLayer().find(".guid-line").forEach((function(e){return e.destroy()}));var i,a,r,o,s,u=getGuides((i=n.target.nodes(),r=null===(a=e.current)||void 0===a?void 0:a.getStage(),o=[],s=[],r.find(t).forEach((function(e){if(!(i.indexOf(e)>=0)){var t=e.getClientRect({skipShadow:!0,skipStroke:!0});o.push(t.x,t.x+t.width,t.x+t.width/2),s.push(t.y,t.y+t.height,t.y+t.height/2)}})),{vertical:o,horizontal:s}),getObjectSnappingEdges(n.target));if(u.length){!function(t){var n,i=null===(n=e.current)||void 0===n?void 0:n.getLayer();t.forEach((function(e){if("H"===e.orientation){var t=new konva_1.default.Line({points:[-6e3,e.lineGuide,6e3,e.lineGuide],stroke:"rgb(0, 161, 255)",strokeWidth:1,name:"guid-line",dash:[4,6]});i.add(t),i.batchDraw()}else if("V"===e.orientation){t=new konva_1.default.Line({points:[e.lineGuide,-6e3,e.lineGuide,6e3],stroke:"rgb(0, 161, 255)",strokeWidth:1,name:"guid-line",dash:[4,6]});i.add(t),i.batchDraw()}}))}(u);var f=n.target.getAbsolutePosition(),d=__assign({},f);u.forEach((function(e){switch(e.snap){case"start":case"center":case"end":switch(e.orientation){case"V":d.x=e.lineGuide+e.offset;break;case"H":d.y=e.lineGuide+e.offset}}}));var c=d.x-f.x,h=d.y-f.y;n.target.nodes().forEach((function(e){var t=e.getAbsolutePosition();e.setAbsolutePosition({x:t.x+c,y:t.y+h})}))}},i=function(e){var t=e.target.getLayer();t.find(".guid-line").forEach((function(e){return e.destroy()})),t.batchDraw()};react_1.default.useEffect((function(){e.current&&(e.current.on("dragmove",n),e.current.on("dragend",i))}))}exports.useSnap=useSnap;