{"ast":null,"code":"\"use strict\";\n\nvar __assign = this && this.__assign || function () {\n  return (__assign = Object.assign || function (e) {\n    for (var t, n = 1, r = arguments.length; n < r; n++) {\n      for (var a in t = arguments[n]) {\n        Object.prototype.hasOwnProperty.call(t, a) && (e[a] = t[a]);\n      }\n    }\n\n    return e;\n  }).apply(this, arguments);\n},\n    __awaiter = this && this.__awaiter || function (e, t, n, r) {\n  return new (n || (n = Promise))(function (a, o) {\n    function i(e) {\n      try {\n        u(r.next(e));\n      } catch (e) {\n        o(e);\n      }\n    }\n\n    function l(e) {\n      try {\n        u(r.throw(e));\n      } catch (e) {\n        o(e);\n      }\n    }\n\n    function u(e) {\n      var t;\n      e.done ? a(e.value) : (t = e.value, t instanceof n ? t : new n(function (e) {\n        e(t);\n      })).then(i, l);\n    }\n\n    u((r = r.apply(e, t || [])).next());\n  });\n},\n    __generator = this && this.__generator || function (e, t) {\n  var n,\n      r,\n      a,\n      o,\n      i = {\n    label: 0,\n    sent: function sent() {\n      if (1 & a[0]) throw a[1];\n      return a[1];\n    },\n    trys: [],\n    ops: []\n  };\n  return o = {\n    next: l(0),\n    throw: l(1),\n    return: l(2)\n  }, \"function\" == typeof Symbol && (o[Symbol.iterator] = function () {\n    return this;\n  }), o;\n\n  function l(o) {\n    return function (l) {\n      return function (o) {\n        if (n) throw new TypeError(\"Generator is already executing.\");\n\n        for (; i;) {\n          try {\n            if (n = 1, r && (a = 2 & o[0] ? r.return : o[0] ? r.throw || ((a = r.return) && a.call(r), 0) : r.next) && !(a = a.call(r, o[1])).done) return a;\n\n            switch (r = 0, a && (o = [2 & o[0], a.value]), o[0]) {\n              case 0:\n              case 1:\n                a = o;\n                break;\n\n              case 4:\n                return i.label++, {\n                  value: o[1],\n                  done: !1\n                };\n\n              case 5:\n                i.label++, r = o[1], o = [0];\n                continue;\n\n              case 7:\n                o = i.ops.pop(), i.trys.pop();\n                continue;\n\n              default:\n                if (!(a = i.trys, (a = a.length > 0 && a[a.length - 1]) || 6 !== o[0] && 2 !== o[0])) {\n                  i = 0;\n                  continue;\n                }\n\n                if (3 === o[0] && (!a || o[1] > a[0] && o[1] < a[3])) {\n                  i.label = o[1];\n                  break;\n                }\n\n                if (6 === o[0] && i.label < a[1]) {\n                  i.label = a[1], a = o;\n                  break;\n                }\n\n                if (a && i.label < a[2]) {\n                  i.label = a[2], i.ops.push(o);\n                  break;\n                }\n\n                a[2] && i.ops.pop(), i.trys.pop();\n                continue;\n            }\n\n            o = t.call(e, i);\n          } catch (e) {\n            o = [6, e], r = 0;\n          } finally {\n            n = a = 0;\n          }\n        }\n\n        if (5 & o[0]) throw o[1];\n        return {\n          value: o[0] ? o[1] : void 0,\n          done: !0\n        };\n      }([o, l]);\n    };\n  }\n},\n    __importDefault = this && this.__importDefault || function (e) {\n  return e && e.__esModule ? e : {\n    default: e\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: !0\n}), exports.TextElement = void 0;\n\nvar react_1 = __importDefault(require(\"react\")),\n    mobx_react_lite_1 = require(\"mobx-react-lite\"),\n    react_konva_1 = require(\"react-konva\"),\n    react_konva_utils_1 = require(\"react-konva-utils\"),\n    mobx_1 = require(\"mobx\"),\n    konva_1 = __importDefault(require(\"konva\")),\n    loader_1 = require(\"../utils/loader\"),\n    apply_filters_1 = require(\"./apply-filters\"),\n    use_fadein_1 = require(\"./use-fadein\"),\n    highlighter_1 = require(\"./highlighter\"),\n    styleNode = document.createElement(\"style\");\n\nstyleNode.type = \"text/css\", document.head.appendChild(styleNode);\n\nvar initialStyles = {\n  border: \"none\",\n  padding: \"0px\",\n  overflow: \"hidden\",\n  background: \"none\",\n  outline: \"none\",\n  resize: \"none\",\n  overflowWrap: \"break-word\",\n  whiteSpace: \"normal\",\n  userSelect: \"text\",\n  wordBreak: \"normal\"\n},\n    TextInput = mobx_react_lite_1.observer(function (e) {\n  var t = e.textNodeRef,\n      n = e.element,\n      r = e.onBlur,\n      a = e.selectAll,\n      o = e.cursorPosition,\n      i = react_1.default.useState(initialStyles),\n      l = i[0],\n      u = i[1],\n      c = t.current;\n  react_1.default.useLayoutEffect(function () {\n    var e = {};\n    e.width = c.width() - 2 * c.padding() + \"px\", e.height = c.height() - 2 * c.padding() + 10 + \"px\", e.fontSize = c.fontSize() + \"px\", e.lineHeight = c.lineHeight() + .01, e.fontFamily = '\"' + c.fontFamily() + '\"', e.textAlign = c.align(), e.color = c.fill();\n    var t = \"\\n        .polotno-input::placeholder {\\n          color: \" + l.color + \";\\n          opacity: 0.6;\\n        }\\n      \";\n    styleNode.innerHTML = \"\", styleNode.appendChild(document.createTextNode(t)), JSON.stringify(e) !== JSON.stringify(l) && u(e);\n  });\n  var s = react_1.default.useRef(null);\n  return react_1.default.useEffect(function () {\n    var e,\n        t = s.current;\n\n    if (t) {\n      null === (e = s.current) || void 0 === e || e.focus();\n      var n = o || t.value.length;\n      t.selectionStart = t.selectionEnd = n, a && (null == t || t.select(), document.execCommand(\"selectAll\", !1, null));\n    }\n  }, []), react_1.default.createElement(react_konva_utils_1.Html, null, react_1.default.createElement(\"textarea\", {\n    className: \"polotno-input\",\n    ref: s,\n    style: __assign(__assign({}, initialStyles), l),\n    value: n.text,\n    onChange: function onChange(e) {\n      n.set({\n        text: e.target.value\n      });\n    },\n    placeholder: n.placeholder,\n    onBlur: r\n  }));\n}),\n    useEditor = function useEditor(e) {\n  var t = react_1.default.useState(!1),\n      n = t[0],\n      r = t[1],\n      a = react_1.default.useRef(!1);\n  return react_1.default.useEffect(function () {\n    var t = !0;\n    return setTimeout(function () {\n      t && (e._editModeEnabled && (a.current = !0), r(!0), setTimeout(function () {\n        a.current = !1;\n      }, 50));\n    }, 50), function () {\n      t = !1;\n    };\n  }, []), {\n    editorEnabled: n && e._editModeEnabled,\n    selectAll: a.current\n  };\n},\n    useFontLoader = function useFontLoader(e, t) {\n  var n = react_1.default.useState(!1),\n      r = n[0],\n      a = n[1];\n  return react_1.default.useLayoutEffect(function () {\n    var n = !0;\n    return __awaiter(void 0, void 0, void 0, function () {\n      return __generator(this, function (o) {\n        switch (o.label) {\n          case 0:\n            return r && a(!1), loader_1.incrementLoader(), [4, e.loadFont(t)];\n\n          case 1:\n            return o.sent(), konva_1.default.Util.requestAnimFrame(loader_1.decrementLoader), n ? (a(!0), [2]) : [2];\n        }\n      });\n    }), function () {\n      n = !1;\n    };\n  }, [t]), [r];\n},\n    getLineHeight = function getLineHeight(e) {\n  var t = e.fontLoaded,\n      n = e.fontFamily,\n      r = e.fontSize,\n      a = e.lineHeight;\n  return react_1.default.useMemo(function () {\n    if (\"number\" == typeof a) return a;\n    var e = document.createElement(\"div\");\n    e.style.fontFamily = n, e.style.fontSize = r + \"px\", e.style.lineHeight = a, e.innerText = \"Test text\", document.body.appendChild(e);\n    var t = e.offsetHeight;\n    return document.body.removeChild(e), t / r;\n  }, [t, n, r, a]);\n};\n\nfunction getRelativePointerPosition(e) {\n  var t = e.getAbsoluteTransform().copy();\n  t.invert();\n  var n = e.getStage().getPointerPosition();\n  return t.point(n);\n}\n\nfunction getCursorPosition(e) {\n  var t,\n      n = e.target,\n      r = getRelativePointerPosition(n),\n      a = n.textArr,\n      o = Math.floor(r.y / (n.fontSize() * n.lineHeight())),\n      i = a.slice(0, o).reduce(function (e, t) {\n    return e + t.text.length;\n  }, o),\n      l = null !== (t = a[o]) && void 0 !== t ? t : a[0],\n      u = 0;\n  return \"right\" === n.align() ? u = n.width() - l.width : \"center\" === n.align() && (u = n.width() / 2 - l.width / 2), i + Math.round((r.x - u) / l.width * l.text.length);\n}\n\nexports.TextElement = mobx_react_lite_1.observer(function (e) {\n  var t = e.element,\n      n = e.store,\n      r = react_1.default.useRef(null),\n      a = useEditor(t),\n      o = a.editorEnabled,\n      i = a.selectAll,\n      l = react_1.default.useState(!1),\n      u = l[0],\n      c = l[1],\n      s = n.selectedElements.indexOf(t) >= 0;\n  react_1.default.useEffect(function () {\n    if (!t.width) {\n      var e = r.current;\n      e.width(600), t.set({\n        width: 1.4 * e.getTextWidth()\n      });\n    }\n  }, []), react_1.default.useEffect(function () {\n    var e = r.current;\n    t.height !== e.height() && t.set({\n      height: e.height()\n    });\n  }), react_1.default.useLayoutEffect(function () {\n    return mobx_1.autorun(function () {\n      var e = r.current;\n      apply_filters_1.applyFilter(e, t);\n    });\n  });\n  var f = useFontLoader(n, t.fontFamily)[0];\n  react_1.default.useLayoutEffect(function () {\n    var e = r.current;\n    e && (e.width(e.width() + 1e-8), e._setTextData(), apply_filters_1.applyFilter(e, t));\n  }, [f]);\n\n  var d = react_1.default.useRef(null),\n      h = react_1.default.useRef(0),\n      _ = function _(e) {\n    n.selectedElements.find(function (e) {\n      return e === t;\n    }) && !t.locked && (h.current = getCursorPosition(e), t.toggleEditMode());\n  },\n      g = !t.text && t.placeholder,\n      p = t._editModeEnabled ? 0 : g ? .6 : t.opacity;\n\n  use_fadein_1.useFadeIn(r, p);\n  var y = getLineHeight({\n    fontLoaded: f,\n    fontFamily: t.fontFamily,\n    fontSize: t.fontSize,\n    lineHeight: t.lineHeight\n  });\n  return react_1.default.createElement(react_1.default.Fragment, null, react_1.default.createElement(react_konva_1.Text, {\n    ref: r,\n    id: t.id,\n    name: \"element\",\n    x: t.x,\n    y: t.y,\n    rotation: t.rotation,\n    width: t.width,\n    text: t.text || t.placeholder,\n    fill: t.fill,\n    stroke: t.stroke,\n    strokeWidth: t.strokeWidth,\n    fillAfterStrokeEnabled: !0,\n    fontSize: t.fontSize,\n    fontFamily: t.fontFamily,\n    fontStyle: t.fontStyle + \" \" + t.fontWeight,\n    textDecoration: t.textDecoration,\n    align: t.align,\n    draggable: !t.locked,\n    opacity: p,\n    shadowEnabled: t.shadowEnabled,\n    shadowBlur: t.shadowBlur,\n    lineHeight: y,\n    letterSpacing: t.letterSpacing * t.fontSize,\n    onDragStart: function onDragStart() {\n      n.history.startTransaction();\n    },\n    onDragEnd: function onDragEnd(e) {\n      t.set({\n        x: e.target.x(),\n        y: e.target.y()\n      }), n.history.endTransaction();\n    },\n    onMouseEnter: function onMouseEnter() {\n      c(!0);\n    },\n    onMouseLeave: function onMouseLeave() {\n      c(!1);\n    },\n    onClick: _,\n    onTap: _,\n    onTransformStart: function onTransformStart() {\n      n.history.startTransaction();\n    },\n    onTransform: function onTransform(e) {\n      var n,\n          r = (null === (n = e.target.getStage()) || void 0 === n ? void 0 : n.findOne(\"Transformer\")).getActiveAnchor();\n\n      if (\"middle-left\" === r || \"middle-right\" === r) {\n        var a = e.target.scaleX(),\n            o = e.target.width() * a,\n            i = t.fontSize,\n            l = o;\n        o < i && (l = i, d.current && e.target.position(d.current)), e.target.width(l), e.target.scaleX(1), apply_filters_1.applyFilter(e.target, t);\n      }\n\n      e.target.strokeWidth(t.strokeWidth / e.target.scaleX()), d.current = e.target.position();\n    },\n    onTransformEnd: function onTransformEnd(e) {\n      var r = e.target.scaleX();\n      e.target.scaleX(1), e.target.scaleY(1), e.target.strokeWidth(t.strokeWidth), t.set({\n        fontSize: t.fontSize * r,\n        width: e.target.width() * r,\n        x: e.target.x(),\n        y: e.target.y(),\n        rotation: e.target.rotation()\n      }), n.history.endTransaction();\n    }\n  }), o && react_1.default.createElement(react_konva_1.Group, {\n    x: t.x,\n    y: t.y,\n    rotation: t.rotation\n  }, react_1.default.createElement(TextInput, {\n    textNodeRef: r,\n    element: t,\n    selectAll: i,\n    cursorPosition: h.current,\n    onBlur: function onBlur() {\n      t.toggleEditMode(!1);\n    }\n  })), !s && u && react_1.default.createElement(highlighter_1.Highlighter, {\n    element: t\n  }));\n});","map":null,"metadata":{},"sourceType":"script"}